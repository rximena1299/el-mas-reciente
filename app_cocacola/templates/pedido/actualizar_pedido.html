{% extends "base.html" %}
{% block content %}
<div class="card mt-4">
  <div class="card-header"><h5>Actualizar Pedido {{ pedido.numero_pedido }}</h5></div>
  <div class="card-body">
    <form method="post" action="{% url 'realizar_actualizacion_pedido' pedido.id %}">
      {% csrf_token %}
      <div class="row mb-2">
        <div class="col-md-6">
          <label>Cliente</label>
          <select name="cliente" class="form-select" required>
            {% for c in clientes %}
              <option value="{{ c.id }}" {% if pedido.cliente.id == c.id %}selected{% endif %}>{{ c.nombre }} {{ c.apellido }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label>Fecha de Entrega</label>
          <input type="date" name="fecha_entrega" class="form-control" value="{{ pedido.fecha_entrega|date:'Y-m-d' }}">
        </div>
      </div>

      <div class="mb-2">
        <label>Dirección de Envío</label>
        <input class="form-control" name="direccion_envio" value="{{ pedido.direccion_envio }}">
      </div>

      <div class="row mb-2">
        <div class="col-md-4">
          <label>Método de Pago</label>
          <select name="metodo_pago" class="form-select">
            <option value="efectivo" {% if pedido.metodo_pago=='efectivo' %}selected{% endif %}>Efectivo</option>
            <option value="tarjeta" {% if pedido.metodo_pago=='tarjeta' %}selected{% endif %}>Tarjeta</option>
            <option value="transferencia" {% if pedido.metodo_pago=='transferencia' %}selected{% endif %}>Transferencia</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>Estado</label>
          <select name="estado" class="form-select">
            <option value="pendiente" {% if pedido.estado=='pendiente' %}selected{% endif %}>Pendiente</option>
            <option value="enviado" {% if pedido.estado=='enviado' %}selected{% endif %}>Enviado</option>
            <option value="entregado" {% if pedido.estado=='entregado' %}selected{% endif %}>Entregado</option>
            <option value="cancelado" {% if pedido.estado=='cancelado' %}selected{% endif %}>Cancelado</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>Gastos de Envío</label>
          <input type="number" step="0.01" name="envio" class="form-control" value="{{ pedido.envio }}">
        </div>
      </div>

      <hr>
      <h6>Productos</h6>
      <div id="items">
        {% for it in items %}
        <div class="row item-row mb-2">
          <div class="col-md-7">
            <select class="form-select" name="product[]">
              <option value="">-- Seleccionar producto --</option>
              {% for p in productos %}
                <option value="{{ p.id }}" {% if p.id == it.producto.id %}selected{% endif %}>{{ p.nombre_producto }} ({{ p.stock_actual }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <input type="number" name="cantidad[]" class="form-control" min="1" value="{{ it.cantidad }}">
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-remove">Quitar</button>
          </div>
        </div>
        {% endfor %}
        {% if items|length == 0 %}
        <div class="row item-row mb-2">
          <div class="col-md-7">
            <select class="form-select" name="product[]">
              <option value="">-- Seleccionar producto --</option>
              {% for p in productos %}
                <option value="{{ p.id }}">{{ p.nombre_producto }} ({{ p.stock_actual }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <input type="number" name="cantidad[]" class="form-control" min="1">
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-remove">Quitar</button>
          </div>
        </div>
        {% endif %}
      </div>

      <button type="button" id="add-item" class="btn btn-sm btn-outline-primary">Agregar otro producto</button>
      <hr>

      <div class="mb-3">
        <label>Observaciones</label>
        <textarea name="observaciones" class="form-control" rows="3">{{ pedido.observaciones }}</textarea>
      </div>

      <button type="submit" class="btn btn-success">Guardar Cambios</button>
      <a href="{% url 'ver_pedido' %}" class="btn btn-secondary">Cancelar</a>
    </form>
  </div>
</div>

<script>
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'add-item'){
    const container = document.getElementById('items');
    const first = container.querySelector('.item-row');
    const clone = first.cloneNode(true);
    clone.querySelector('select').value = '';
    clone.querySelector('input[name="cantidad[]"]').value = '';
    container.appendChild(clone);
  }
  if(e.target && e.target.classList.contains('btn-remove')){
    const row = e.target.closest('.item-row');
    if(document.querySelectorAll('.item-row').length > 1){
      row.remove();
    } else {
      row.querySelector('select').value = '';
      row.querySelector('input[name="cantidad[]"]').value = '';
    }
  }
});
</script>
{% endblock %}
